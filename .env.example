# Lattice JSON API Server Configuration

# Server listening address (0.0.0.0 allows external connections)
SERVER_HOST=0.0.0.0

# Server listening port
SERVER_PORT=8698

# Log level (trace, debug, info, warn, error)
RUST_LOG=debug

# Log format for local output (`compact` or `json`)
LOG_FORMAT=compact

# When true, json-api-dev runs all `cargo run` commands with `--release`.
JSON_API_DEV_RELEASE=false

# PostgreSQL connection string for local app usage.
# IMPORTANT: this role must NOT have SUPERUSER or BYPASSRLS, or tenant RLS will be bypassed.
DATABASE_URL="postgresql://lattice_app:lattice_app_password@localhost:5432/lattice_db"

# Docker Compose PostgreSQL overrides.
# POSTGRES_USER and POSTGRES_PASSWORD initialise the PostgreSQL superuser and are
# also forwarded to json-api-dev to auto-provision the matching OpenBao KV secret
# on first startup. Admin credentials for migrations are stored in OpenBao KV
# (see OPENBAO_POSTGRES_SECRET_PATH below).
POSTGRES_DB=lattice_db
POSTGRES_USER=lattice_user
POSTGRES_PASSWORD=lattice_password
POSTGRES_INITDB_ARGS="--encoding=UTF-8 --lc-collate=C --lc-ctype=C"

# OpenBao Transit HMAC settings.

# OPENBAO_ADDR: address of the OpenBao server.
OPENBAO_ADDR="http://localhost:8200"

# OPENBAO_TOKEN: authentication token for OpenBao.
OPENBAO_TOKEN="replace-with-openbao-token"

# OPENBAO_TRANSIT_KEY: transit key name used for HMAC operations.
OPENBAO_TRANSIT_KEY="lattice"

# KV path where admin DB credentials (admin_user, admin_password) are stored.
# On json-api-dev startup with OPENBAO_DEV_AUTO_PROVISION=true, dev defaults are
# written automatically. In production, write this secret manually before deploying.
OPENBAO_POSTGRES_SECRET_PATH=secret/data/lattice/postgres

# Dev OpenBao settings used by docker-compose `openbao-dev` and `json-api-dev`.
OPENBAO_DEV_ROOT_TOKEN="lattice-dev-root-token"
OPENBAO_ADDR_DOCKER="http://openbao-dev:8200"

# Default tenant/bootstrap data created automatically by `just dev`.
DEV_TENANT_NAME="Dev Tenant"
DEV_TENANT_UUID="00000000-0000-0000-0000-000000000001"

# Optional Docker-only database URL override used by json-api services
DATABASE_URL_DOCKER="postgresql://lattice_app:lattice_app_password@postgres:5432/lattice_db"

# OpenTelemetry tracing configuration.
# `OTEL_EXPORTER_OTLP_ENDPOINT` is used when running the service on host.
# `OTEL_EXPORTER_OTLP_ENDPOINT_DOCKER` points to the Alloy service in Docker Compose.
OTEL_ENABLED=true
OTEL_PARENT_PROPAGATION_ENABLED=false
OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4317"
OTEL_EXPORTER_OTLP_ENDPOINT_DOCKER="http://alloy:4317"
OTEL_EXPORTER_OTLP_TIMEOUT_SECONDS=3
OTEL_SERVICE_NAME="lattice-json"
OTEL_SERVICE_VERSION="0.3.0"
OTEL_DEPLOYMENT_ENVIRONMENT="development"
OTEL_TRACE_SAMPLE_RATIO=1.0

PYROSCOPE_ENABLED=false
PYROSCOPE_ENABLED_DOCKER=true
PYROSCOPE_SERVER_ADDRESS="http://localhost:4040"
PYROSCOPE_SERVER_ADDRESS_DOCKER="http://pyroscope:4040"
PYROSCOPE_SAMPLE_RATE=100
# WARNING: enabling per-request tags can add significant request overhead.
PYROSCOPE_REQUEST_TAGS_ENABLED=false
SLOW_REQUEST_THRESHOLD_MS=1000

# Docker Compose pgAdmin overrides
PGADMIN_PORT=8091
PGADMIN_DEFAULT_EMAIL=admin@example.com
PGADMIN_DEFAULT_PASSWORD=admin
PGADMIN_CONFIG_SERVER_MODE=False
PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False

# Docker Compose Grafana overrides
GRAFANA_PORT=3000
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin
PROMETHEUS_PORT=9090
PYROSCOPE_PORT=4040

# Host user/group IDs â€” ensures files created inside containers (e.g. sqlx migrations)
# are owned by the host user rather than root.
HOST_UID=1000
HOST_GID=1000
