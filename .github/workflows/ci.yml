name: Build & Test

env:
  CARGO_TERM_COLOR: always
  TARPAULIN_VERSION: "0.31.2"
  MSRV: "1.93.0"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  format_and_lint:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-Dwarnings"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.MSRV }}
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    env:
      RUSTFLAGS: "-Dwarnings"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.MSRV }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Run tests
        run: cargo test --all-features --workspace

  coverage:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-Dwarnings"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.MSRV }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Cache tools
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/cargo-tarpaulin
          key: ${{ runner.os }}-tarpaulin-${{ env.TARPAULIN_VERSION }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-tarpaulin
        run: |
          if ! command -v cargo-tarpaulin &> /dev/null; then
            cargo install cargo-tarpaulin --version ${{ env.TARPAULIN_VERSION }}
          fi

      - name: Run tests with coverage
        run: |
          # Run tarpaulin and capture output for coverage parsing
          cargo tarpaulin --verbose --all-features --workspace --timeout 600 --out Lcov | tee coverage_output.txt

      - name: Check coverage threshold
        run: |
          set -euo pipefail
          # Extract coverage percentage from tarpaulin output (supports integers and decimals)
          COVERAGE=$(grep -oE '[0-9]+(\.[0-9]+)?% coverage' coverage_output.txt | sed 's/% coverage//' | head -1 || true)
          if [ -z "${COVERAGE:-}" ]; then
            echo "❌ Could not parse coverage percentage from coverage_output.txt"
            echo "---- coverage_output.txt ----"
            tail -n +1 coverage_output.txt || true
            exit 1
          fi
          echo "Coverage: ${COVERAGE}%"
          # Check if coverage meets 70% threshold (numeric compare via awk)
          awk -v c="$COVERAGE" 'BEGIN{ if (c+0 >= 70) { print "✅ Coverage " c "% meets minimum threshold of 70%"; exit 0 } else { print "❌ Coverage " c "% is below minimum threshold of 70%"; exit 1 } }'

  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run security audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  docs:
    runs-on: ubuntu-latest
    env:
      RUSTDOCFLAGS: "-Dwarnings"
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.MSRV }}

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check documentation
        run: cargo doc --no-deps --all-features
